FROM node:20-alpine

WORKDIR /app

# Build args for environment variables
ARG NEXT_PUBLIC_BACKEND_URL=http://localhost:8000
ENV NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL}

# Copy package files
COPY package*.json ./

# Install all dependencies (including devDependencies for dev mode)
# Use npm install for dev mode to handle lock file sync issues
RUN npm install --no-audit && \
    npm list recharts >/dev/null 2>&1 && echo "recharts verified" || (echo "recharts not found, installing..." && npm install recharts --no-audit)

# Copy entrypoint script
COPY docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Expose port
EXPOSE 3000

# Development mode - no build, just run dev server
ENV NODE_ENV=development
ENV PORT=3000
ENV HOSTNAME=0.0.0.0

# Use entrypoint to ensure dependencies are installed
ENTRYPOINT ["docker-entrypoint.sh"]

# Start Next.js dev server with hot reload
CMD ["npm", "run", "dev"]
