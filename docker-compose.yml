services:
  mysql:
    image: mysql:8.0
    container_name: movie_mysql
    restart: unless-stopped
    env_file:
      - .env
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./data.sql:/docker-entrypoint-initdb.d/data.sql:ro
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./Film_BE
      dockerfile: Dockerfile
    container_name: movie_backend
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      - DJANGO_SETTINGS_MODULE=Film_BE.settings
      - DB_HOST=${DB_HOST}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_PORT=${DB_PORT}
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - DJANGO_DEBUG=${DJANGO_DEBUG}
      - ADMIN_USERNAME=${ADMIN_USERNAME}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    volumes:
      # Mount source code for hot reload
      - ./Film_BE:/app
    entrypoint: ["/app/docker-entrypoint.sh"]
    command: >
      sh -c "
        echo 'Waiting for MySQL...' &&
        until python3 -c 'import mysql.connector; mysql.connector.connect(host=\"${DB_HOST}\", user=\"${DB_USER}\", password=\"${DB_PASSWORD}\", database=\"${DB_NAME}\")' 2>/dev/null; do
          echo 'MySQL is unavailable - sleeping'
          sleep 2
        done &&
        echo 'MySQL is up - handling migrations...' &&
        python3 manage.py migrate --fake-initial --noinput 2>&1 || python3 manage.py migrate --noinput 2>&1 || echo 'Migrations handled' &&
        python3 -c \"import mysql.connector; cnx = mysql.connector.connect(host='${DB_HOST}', user='${DB_USER}', password='${DB_PASSWORD}', database='${DB_NAME}'); cursor = cnx.cursor(); cursor.execute('CREATE TABLE IF NOT EXISTS django_session (session_key varchar(40) NOT NULL PRIMARY KEY, session_data longtext NOT NULL, expire_date datetime(6) NOT NULL, KEY django_session_expire_date_a5c62663 (expire_date)) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;'); cnx.commit(); cursor.close(); cnx.close(); print('django_session table ready')\" 2>&1 || echo 'Session table check completed' &&
        echo 'Creating admin user...' &&
        python3 create_admin.py 2>&1 || echo 'Admin user check completed' &&
        echo 'Starting Django development server with auto-reload...' &&
        exec python3 manage.py runserver 0.0.0.0:8000
      "

  frontend:
    build:
      context: ./Film_FE
      dockerfile: Dockerfile.dev
      args:
        - NEXT_PUBLIC_BACKEND_URL=http://localhost:8000
    container_name: movie_frontend
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_BACKEND_URL=http://localhost:8000
      - WATCHPACK_POLLING=true
    volumes:
      # Mount source code for hot reload
      - ./Film_FE/app:/app/app
      - ./Film_FE/public:/app/public
      - ./Film_FE/next.config.js:/app/next.config.js
      - ./Film_FE/tailwind.config.ts:/app/tailwind.config.ts
      - ./Film_FE/tsconfig.json:/app/tsconfig.json
      - ./Film_FE/postcss.config.js:/app/postcss.config.js
      - ./Film_FE/package.json:/app/package.json
      - ./Film_FE/package-lock.json:/app/package-lock.json
      # Exclude node_modules and .next to use container's versions
      - /app/node_modules
      - /app/.next

volumes:
  mysql_data:
